<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WAVE — Projects</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <img src="images/header.jpg" class="header-img" alt="WAVE header">
      <div class="brand">
        <h1>WAVE Projects</h1>
        <p class="tag">नई खोजें • AGI संकेत • प्रयोग</p>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="controls">
      <input id="search" placeholder="खोजें — प्रोजेक्ट / टैग..." />
      <div class="muted small">
        Admin mode: <strong id="adminMode">OFF</strong>  
        (URL में ?admin=1 जोड़ें)
      </div>
    </section>

    <section id="grid" class="grid"></section>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button id="closeModal" class="close-btn">✕</button>
      <h3 id="modalTitle">Settings</h3>
      <pre id="modalJson" class="json-view"></pre>
      <div class="modal-actions">
        <a id="editOnGit" target="_blank" class="btn">Edit on GitHub</a>
        <button id="downloadJson" class="btn">Download JSON</button>
      </div>
      <p class="muted small">यह page static है — बदलाव के लिए projects.json edit करें</p>
    </div>
  </div>

<script>
(async function(){

  const ADMIN = new URL(location).searchParams.get("admin") === "1";
  document.getElementById("adminMode").textContent = ADMIN ? "ON" : "OFF";

  const grid = document.getElementById("grid");
  const search = document.getElementById("search");

  async function loadProjects(){
    try {
      const r = await fetch("projects.json", {cache:"no-store"});
      return await r.json();
    } catch(e){
      console.error(e);
      return [];
    }
  }

  function createCard(p){
    const card = document.createElement("article");
    card.className = "card";

    const thumb = document.createElement("div");
    thumb.className = "thumb";
    thumb.innerHTML = `<img src="${p.thumbnail || 'images/thumb-sample.jpg'}" alt="">`;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `
      <h4>${p.title || ''}</h4>
      <p class="desc">${p.description || ""}</p>
      <div class="meta-bottom">
        <span class="muted small">${p.duration || ""}</span>
        <span class="muted small">${(p.tags||[]).join(", ")}</span>
      </div>
    `;

    card.appendChild(thumb);
    card.appendChild(meta);

    card.addEventListener("click", (e)=>{
      if (e.target.closest(".settings-btn")) return;
      if (p.playUrl) window.open(p.playUrl, "_blank");
      else if (p.artifactPath) window.open(p.artifactPath, "_blank");
      else alert('Play link या artifact नहीं मिला।');
    });

    if (ADMIN){
      const sb = document.createElement("button");
      sb.className = "settings-btn";
      sb.textContent = "Settings";
      sb.onclick = (ev)=>{
        ev.stopPropagation();
        openSettingsModal(p);
      };
      card.appendChild(sb);
    }

    return card;
  }

  function render(list){
    grid.innerHTML = "";
    if (!list.length){
      grid.innerHTML = "<div class='muted'>कोई प्रोजेक्ट नहीं मिला।</div>";
      return;
    }
    list.forEach(p => grid.appendChild(createCard(p)));
  }

  function filter(list){
    const q = search.value.trim().toLowerCase();
    if (!q) return list;
    return list.filter(p=>{
      const hay = (p.title + " " + p.description + " " + (p.tags||[]).join(" ")).toLowerCase();
      return hay.includes(q);
    });
  }

  const all = await loadProjects();
  render(all);

  search.oninput = ()=>render(filter(all));

  // ----- Modal -----
  const modal = document.getElementById("modal");
  const modalJson = document.getElementById("modalJson");
  const modalTitle = document.getElementById("modalTitle");
  const editOnGit = document.getElementById("editOnGit");
  const downloadJson = document.getElementById("downloadJson");
  const closeModal = document.getElementById("closeModal");

  function openSettingsModal(p){
    modalJson.textContent = JSON.stringify(p, null, 2);
    modalTitle.textContent = p.title;
    editOnGit.href = "https://github.com/RWAY00/wave-projects/edit/main/projects.json";
    downloadJson.onclick = ()=>downloadObj(p, p.id+".json");
    modal.style.display = "flex";
    modal.setAttribute('aria-hidden','false');
  }

  closeModal.onclick = ()=>{ modal.style.display="none"; modal.setAttribute('aria-hidden','true'); };
  modal.onclick = (ev)=>{ if (ev.target===modal) { modal.style.display="none"; modal.setAttribute('aria-hidden','true'); } };

  function downloadObj(o, name){
    const blob = new Blob([JSON.stringify(o,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = name;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

})();
</script>

</body>
</html>
